import{a as o}from"./chunk-B2LUGKIE.js";import{Qa as b,g as a,j as p,l,p as g,s as c,v as f,y as d}from"./chunk-6P7KIDLQ.js";var n=class extends Error{};n.prototype.name="InvalidTokenError";function k(s){return decodeURIComponent(atob(s).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function v(s){let e=s.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return k(e)}catch{return atob(e)}}function h(s,e){if(typeof s!="string")throw new n("Invalid token specified: must be a string");e||(e={});let t=e.header===!0?0:1,r=s.split(".")[t];if(typeof r!="string")throw new n(`Invalid token specified: missing part #${t+1}`);let i;try{i=v(r)}catch(u){throw new n(`Invalid token specified: invalid base64 for part #${t+1} (${u.message})`)}try{return JSON.parse(i)}catch(u){throw new n(`Invalid token specified: invalid json for part #${t+1} (${u.message})`)}}var m=class s{constructor(e){this.http=e;this.setupAutoRefresh()}loggedIn$=new a(this.isLoggedIn());userRefresh$=new a(void 0);isAuthCheckDone$=new a(!1);refreshTimer;getAuthCheckDoneObservable(){return this.isAuthCheckDone$.asObservable()}setAuthCheckDone(e){this.isAuthCheckDone$.next(e)}register(e,t,r){return this.http.post(`${o.apiBaseUrl}/auth/register`,{email:e,password:t,username:r})}login(e,t){return this.http.post(`${o.apiBaseUrl}/auth/login`,{email:e,password:t},{withCredentials:!0}).pipe(c(r=>{localStorage.setItem("access_token",r.access_token),this.setLoginStatus(!0),this.setupAutoRefresh()}),l(()=>{}))}logout(){return this.http.post(`${o.apiBaseUrl}/auth/logout`,{},{withCredentials:!0,headers:{Authorization:`Bearer ${this.getAccessToken()}`}}).pipe(c(()=>{localStorage.removeItem("access_token"),this.setLoginStatus(!1),clearTimeout(this.refreshTimer)}))}refreshToken(){return this.http.post(`${o.apiBaseUrl}/auth/refresh`,{},{withCredentials:!0}).pipe(c(e=>{localStorage.setItem("access_token",e.access_token),this.setLoginStatus(!0)}),g(e=>(localStorage.removeItem("access_token"),this.setLoginStatus(!1),p(()=>e))))}setupAutoRefresh(){let e=this.getAccessToken();if(e)try{let{exp:t}=h(e),i=t*1e3-Date.now()-6e4;i<=0?this.tryRefreshToken():(clearTimeout(this.refreshTimer),this.refreshTimer=setTimeout(()=>{this.tryRefreshToken()},i))}catch(t){console.error("Error decoding token:",t)}}tryRefreshToken(){this.refreshToken().subscribe({next:()=>{this.setupAutoRefresh()},error:()=>{this.logout().subscribe()}})}getAccessToken(){return localStorage.getItem("access_token")}isLoggedIn(){let e=this.getAccessToken();if(!e)return!1;try{let{exp:t}=h(e);return Date.now()<t*1e3}catch{return!1}}setLoginStatus(e){this.loggedIn$.next(e)}getLoginStatusObservable(){return this.loggedIn$.asObservable()}setAccessToken(e){localStorage.setItem("access_token",e),this.setLoginStatus(!0),this.setupAutoRefresh()}getUserRefreshObservable(){return this.userRefresh$.asObservable()}triggerUserRefresh(){this.userRefresh$.next()}isTokenExpired(e){try{let{exp:t}=h(e);return Date.now()>=t*1e3}catch{return!0}}resendVerificationEmail(e){return this.http.post(`${o.apiBaseUrl}/auth/request-verification`,{email:e})}requestPasswordReset(e){return this.http.post(`${o.apiBaseUrl}/auth/request-password-reset`,{email:e})}static \u0275fac=function(t){return new(t||s)(d(b))};static \u0275prov=f({token:s,factory:s.\u0275fac,providedIn:"root"})};export{h as a,m as b};
