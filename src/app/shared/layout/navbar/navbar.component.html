<ng-container *ngIf="isAuthChecked">
  <nav class="bg-[#141C22] text-white px-6 py-4 relative">
    <div class="flex justify-between items-center relative" #navContainer>
      <!-- Logo -->
      <a routerLink="/"
        [routerLinkActive]="'text-[#3DB34A]'"
        class="flex items-center gap-2 cursor-pointer"
        (click)="resetUnderline(true)">
        <img src="assets/branding/logo-small.svg" alt="Logo" class="h-8" />
        <span class="text-xl font-bold text-[#3DB34A]">
          <span class="text-white">Task</span>Flow
        </span>
      </a>

      <!-- License Badge -->
      <a routerLink="/pricing"
        class="hidden md:flex items-center gap-2 px-4 py-1 bg-[#20272E] rounded-lg border border-[#3DB34A] text-[#3DB34A] text-sm shadow-sm hover:bg-[#2A323B] hover:border-[#34a042] hover:text-[#34a042] transition cursor-pointer">
        <svg class="w-4 h-4 text-[#3DB34A] animate-pulse" fill="currentColor" viewBox="0 0 20 20">
          <circle cx="10" cy="10" r="5" />
        </svg>
        <span>Plans Available â€” Limited Time Offer</span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-6 text-sm">
        <a routerLink="/pricing" (mouseenter)="moveUnderline($event)" (mouseleave)="resetUnderline()" (click)="lockUnderline($event)"
          [routerLinkActive]="'text-[#3DB34A]'"
          class="hover:text-[#3DB34A] cursor-pointer">
          Get Access
        </a>

        <a routerLink="/faq" (mouseenter)="moveUnderline($event)" (mouseleave)="resetUnderline()" (click)="lockUnderline($event)"
          [routerLinkActive]="'text-[#3DB34A]'"
          class="hover:text-[#3DB34A] cursor-pointer">
          FAQ
        </a>

        <ng-container *ngIf="isLoggedIn">
          <a
            [routerLink]="hasActiveSubscription ? '/dashboard' : null"
            (click)="!hasActiveSubscription ? router.navigate(['/pricing']) : null"
            [ngClass]="{
              'opacity-50 cursor-not-allowed': !hasActiveSubscription,
              'bg-gradient-to-br from-[#3DB34A] to-[#2DA436]': hasActiveSubscription
            }"
            class="relative inline-flex items-center gap-2 px-5 py-2 rounded-full font-semibold text-sm text-black shadow-md ring-1 ring-[#2DA436] hover:ring-2 hover:ring-offset-2 transition-all duration-300 ease-in-out transform hover:scale-[1.05] hover:shadow-xl focus:outline-none"
            title="Dashboard (requires active subscription)"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-black opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h11l-1 9m-4-9V6a4 4 0 118 0v4" />
            </svg>
            Dashboard
          </a>
        </ng-container>

        <div class="h-6 w-px bg-gray-600 mx-0"></div>

        <ng-container *ngIf="!isLoggedIn; else loggedIn">
          <a routerLink="/auth/login" (mouseenter)="moveUnderline($event)" (mouseleave)="resetUnderline()" (click)="lockUnderline($event)"
            [routerLinkActive]="'text-[#3DB34A]'" class="hover:text-white text-gray-300 cursor-pointer">
            Sign In
          </a>
          <a routerLink="/auth/register" (mouseenter)="moveUnderline($event)" (mouseleave)="resetUnderline()" (click)="lockUnderline($event)"
            [routerLinkActive]="'text-[#3DB34A]'"
            class="bg-[#3DB34A] hover:bg-[#34a042] text-sm px-4 py-2 rounded text-black font-semibold cursor-pointer">
            Sign Up
          </a>
        </ng-container>

        <ng-template #loggedIn>
          <div class="flex items-center gap-5">
            <!-- Avatar + Desktop Menu -->
            <div class="relative user-menu-container">
              <img #avatarRef [src]="avatarUrl || 'assets/avatars/default_avatar.svg'"
                class="w-8 h-8 rounded-full border-gray-500 cursor-pointer hover:opacity-80 transition"
                alt="User Avatar" title="Open user menu"
                (click)="onAvatarClick($event)"
                (mouseenter)="showUserMenu ? null : moveUnderline($event)"
                (mouseleave)="showUserMenu ? null : resetUnderline()" />

              <!-- Dropdown Menu -->
              <div *ngIf="showUserMenu" class="absolute right-0 mt-2 w-48 bg-[#1C262E] rounded-lg shadow-lg py-2 z-50 border border-[#2A323B]">
                <a routerLink="/profile" class="block px-4 py-2 text-sm text-white hover:bg-[#2A323B] transition">
                  My Profile
                </a>
                <a routerLink="/subscription" class="block px-4 py-2 text-sm text-white hover:bg-[#2A323B] transition">
                  Subscription
                </a>
                <button (click)="logout(); toggleUserMenu()" class="w-full text-left px-4 py-2 text-sm text-red-400 hover:text-red-300 transition cursor-pointer">
                  Logout
                </button>
              </div>
            </div>
          </div>
        </ng-template>
      </div>

      <!-- Shared Underline -->
      <div *ngIf="underlineStyle.left && underlineStyle.width" class="absolute -bottom-3 left-0 w-full h-[2px] pointer-events-none z-50 hidden md:block">
        <div class="absolute h-[2px] bg-white rounded-full transition-all duration-300" [ngStyle]="underlineStyle"></div>
      </div>

      <!-- Mobile Burger -->
      <div class="md:hidden z-50 relative">
        <button (click)="toggleMobileMenu()" class="focus:outline-none">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div
      [class.hidden]="!mobileMenuOpen"
      id="mobile-menu"
      class="md:hidden flex flex-col items-start gap-3 text-sm pl-4 pr-4 w-full bg-[#141C22] pb-4 pt-6"
    >
      <a routerLink="/pricing"
        class="hover:text-[#3DB34A] text-white w-full text-left transition"
        (click)="toggleMobileMenu()">
        Get Access
      </a>

      <a routerLink="/faq"
        class="hover:text-[#3DB34A] text-white w-full text-left transition"
        (click)="toggleMobileMenu()">
        FAQ
      </a>

      <ng-container *ngIf="isLoggedIn; else loggedOutMobile">
        <a routerLink="/dashboard"
          class="bg-gradient-to-br from-[#3DB34A] to-[#2DA436] text-black font-semibold px-4 py-2 rounded-md w-full text-center shadow-sm cursor-pointer transition"
          (click)="toggleMobileMenu()">
          Dashboard
        </a>

        <div class="h-px bg-gray-700 my-1 w-full"></div>

        <div class="flex flex-col gap-1 w-full mt-2 text-gray-300">
          <span class="text-xs">Hello, {{ username }}</span>
          <button (click)="logout(); toggleMobileMenu()"
                  class="text-xs text-red-400 hover:underline text-left cursor-pointer">
            Logout
          </button>
        </div>
      </ng-container>

      <ng-template #loggedOutMobile>
        <div class="h-px bg-gray-700 my-1 w-full"></div>

        <a routerLink="/auth/login"
          class="w-full bg-[#2A2F35] hover:bg-[#353B42] text-white text-sm font-semibold px-4 py-2 rounded-md text-center transition"
          (click)="toggleMobileMenu()">
          Sign In
        </a>

        <a routerLink="/auth/register"
          class="w-full bg-[#3DB34A] hover:bg-[#34a042] text-black text-sm font-semibold px-4 py-2 rounded-md text-center transition"
          (click)="toggleMobileMenu()">
          Sign Up
        </a>
      </ng-template>
    </div>
  </nav>
</ng-container>
